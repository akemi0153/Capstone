<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IGP SmartStock - Inventory Management System</title>
    
    <!-- Emergency fallback: Always show page after 3 seconds -->
    <script>
        setTimeout(function() {
            document.body.classList.remove('loading');
            document.body.classList.add('loaded');
            const loader = document.getElementById('authLoader');
            if (loader) loader.style.display = 'none';
        }, 3000);
    </script>
    
    <!-- IMMEDIATE AUTH CHECK - Blocks unauthorized access -->
    <script type="module">
        (async function() {
            try {
                const { createClient } = await import("https://esm.sh/@supabase/supabase-js@2");
                const { SUPABASE_CONFIG } = await import("./config/credentials.js");
                
                const supabase = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
                
                // Immediate session check before page renders
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (!session || error) {
                    // No valid session - redirect immediately
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.replace("Log In.html");
                    return;
                }
                
                // Store user data for quick access
                const user = session.user;
                localStorage.setItem("userFullName", user.user_metadata?.full_name || "");
                localStorage.setItem("userEmail", user.email);
                
                // Show page immediately
                const loader = document.getElementById('authLoader');
                if (loader) loader.style.display = 'none';
                document.body.classList.remove('loading');
                document.body.classList.add('loaded');
                
                // Update welcome message with user's name after DOM loads
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', updateWelcome);
                } else {
                    updateWelcome();
                }
                
                function updateWelcome() {
                    const welcomeMessageEl = document.getElementById("welcomeMessage");
                    if (welcomeMessageEl) {
                        const displayName = user.user_metadata?.full_name || user.email.split('@')[0];
                        welcomeMessageEl.textContent = `Welcome, ${displayName}`;
                    }
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                // Show page anyway to prevent blank screen
                document.body.classList.remove('loading');
                document.body.classList.add('loaded');
                const loader = document.getElementById('authLoader');
                if (loader) loader.style.display = 'none';
                
                // If auth completely fails, redirect after showing error
                setTimeout(() => {
                    if (!localStorage.getItem('userEmail')) {
                        window.location.replace("Log In.html");
                    }
                }, 1000);
            }
        })();
    </script>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Tailwind Config -->
    <script src="animation/tailwind-config.js"></script>
    
    <!-- Authentication Script - MUST load as module and block rendering -->
    <script type="module" src="animation/auth.js"></script>
</head>
<body class="bg-white min-h-full loading">
    <!-- Loading state while auth check runs -->
    <div id="authLoader">
        <div>
            <div class="spinner"></div>
            <p class="spinner-text">Loading...</p>
        </div>
    </div>
    <div class="min-h-full flex bg-gray-50">
        <!-- Sidebar Component (Loaded Dynamically) -->
        <div id="sidebar"></div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header Component (Loaded Dynamically) -->
            <div id="header"></div>

            <!-- Content Area -->
            <main class="flex-1 overflow-y-auto p-6 ml-64">
                <!-- Page Content (Loaded Dynamically) -->
                <div id="mainContent"></div>
            </main>
        </div>
    </div>

    <!-- Modals Component (Loaded Dynamically) -->
    <div id="modals"></div>

    <!-- Main Application Script -->
    <script type="module">
        console.log('üì¶ Loading main application script...');
        import('./scripts/main.js')
            .then(() => console.log('‚úÖ Main script loaded successfully'))
            .catch(err => {
                console.error('‚ùå Failed to load main script:', err);
                document.body.innerHTML = `
                    <div style="display: flex; align-items: center; justify-center; height: 100vh; padding: 2rem; font-family: system-ui;">
                        <div style="text-align: center; max-width: 500px;">
                            <h1 style="color: #dc2626; font-size: 1.5rem; margin-bottom: 1rem;">Failed to Load Application</h1>
                            <p style="color: #6b7280; margin-bottom: 1rem;">Could not load the main application script.</p>
                            <p style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 1.5rem;">${err.message}</p>
                            <button onclick="location.reload()" style="padding: 0.5rem 1rem; background: #eab308; border: none; border-radius: 0.5rem; cursor: pointer; font-weight: 500;">
                                Reload Page
                            </button>
                        </div>
                    </div>
                `;
            });
    </script>
</body>
</html>
